action: fire-dom-event
browser_mod:
  service: browser_mod.popup
  data:
    title: Consommation électrique
    size: fullscreen
    content:
      type: grid
      columns: 2
      square: false
      cards:

        - type: custom:tabbed-card
          styles:
            --mdc-theme-primary: var(--primary-text-color)
            --mdc-tab-text-label-color-default: rgba(var(--rgb-primary-text-color), 0.8)
            --mdc-typography-button-font-size: 14px
          tabs:
            - card: ### Quotidienne (15j)
                type: vertical-stack
                cards:
                  # https://github.com/RomRider/apexcharts-card
                  - type: custom:apexcharts-card
                    header:
                      show: true
                      # title: Historique des 15 derniers jours
                      show_states: true
                      colorize_states: true
                    graph_span: 15d
                    update_interval: 1d
                    update_delay: 2h
                    stacked : true
                    locale: fr
                    color_list: [var(--primary-color), var(--secondary-color), var(--third-color), var(--fourth-color), var(--fifth-color)]
                    show:
                      last_updated: true
                    apex_config:
                      chart:
                        fontFamily: var(--primary-font-family)
                        height: 550px
                      # xaxis:
                      #   labels:
                      #     show: false
                          # datetimeFormatter:
                          #   day: 'dddd'
                      tooltip:
                        enable: true
                        shared: true
                        intersect: false
                        # enabledOnSeries: [0,1,2,3,4,5,6,7,8]
                        style:
                          fontSize: 14px
                        x:
                          show: true
                          format: 'dddd d MMMM'
                        y:
                          show: true
                          # formatter: |
                          #   function({ series, seriesIndex, dataPointIndex, w }) {
                          #     let currentTotal = 0
                          #     series.forEach((s) => {
                          #       currentTotal += s[dataPointIndex]
                          #     })
                          #     return '<div class="custom-tooltip">' +
                          #       '<span><b>Total: </b>' + currentTotal + '</span>' +
                          #       '</div>'
                          #   }
                      legend:
                        show : false 
                    yaxis:
                      - id: elec
                        show: true
                        max: 10
                        opposite: true
                        apex_config:
                          forceNiceScale: true
                          decimalsInFloat: 0
                          labels:
                            formatter: |
                              EVAL:v => `${v.toFixed(0)} kWh`
                      # - id : temp
                      #   show: true
                      #   apex_config:
                      #     title:
                      #       text: Température extérieure
                      #     forceNiceScale: true
                      #     decimalsInFloat: 0
                      #     labels:
                      #       style:
                      #         color: var(--primary-color)
                      #       formatter: |
                      #         EVAL:v => `${v.toFixed(0)} °C`
                    all_series_config:
                      type: column
                      opacity: 0.2
                    series:
                      - entity: sensor.daily_plug_bureau_energy
                        name: PC Bureau
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_plug_media_salon_energy
                        name: Media salon
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_plug_chambre_energy
                        name: Prises chambre (lit)
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_wiser_lts_energy_salon
                        name: Chauffage du salon (convecteur)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_wiser_lts_energy_salon_2
                        name: Chauffage du salon (inertie)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_wiser_lts_energy_bureau
                        name: Chauffage du bureau
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.daily_wiser_lts_energy_chambre
                        name: Chauffage de la chambre
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      # - entity: sensor.tz3000_2putqrmw_ts011f_summation_delivered
                      #   name: Prise du bar
                      #   stroke_width: 1
                      #   yaxis_id: elec
                      #   group_by:
                      #     duration: 1d
                      #     func: max
                      - entity: sensor.prise_chambre_2_summation_delivered_2
                        name: Prise de la chambre (entrée)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max

                      # - entity: sensor.paris_10eme_arrondissement_temperature
                      #   name: Température extérieure
                      #   yaxis_id: temp
                      #   type: line
                      #   color: var(--primary-color)
                      #   unit: '°C'
                      #   stroke_width: 2
                      #   show:
                      #     in_header: false
                      #   opacity: 1
                      #   group_by:
                      #     duration: 1d
                      #     func: avg

              attributes:
                label: Quotidienne (15j)

            - card: ### Mensuelle
                type: vertical-stack
                cards:
                  # https://github.com/RomRider/apexcharts-card
                  - type: custom:apexcharts-card
                    header:
                      show: true
                      show_states: true
                      colorize_states: true
                    graph_span: 12m
                    update_interval: 1m
                    update_delay: 15d
                    stacked : true
                    locale: fr
                    color_list: [var(--primary-color), var(--secondary-color), var(--third-color), var(--fourth-color), var(--fifth-color)]
                    show:
                      last_updated: true
                    apex_config:
                      chart:
                        fontFamily: var(--primary-font-family)
                        height: 550px
                      tooltip:
                        enable: true
                        shared: true
                        intersect: false
                        style:
                          fontSize: 14px
                        x:
                          show: true
                          format: 'MMMM'
                        y:
                          show: true
                      legend:
                        show : false 
                    yaxis:
                      - id: elec
                        show: true
                        max: 10
                        opposite: true
                        apex_config:
                          forceNiceScale: true
                          decimalsInFloat: 0
                          labels:
                            formatter: |
                              EVAL:v => `${v.toFixed(0)} kWh`
                    all_series_config:
                      type: column
                      opacity: 0.2
                    series:
                      - entity: sensor.monthly_plug_bureau_energy
                        name: PC Bureau
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_plug_media_salon_energy
                        name: Media salon
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_plug_chambre_energy
                        name: Prises chambre (lit)
                        stroke_width: 1
                        yaxis_id: elec
                        transform: "return x / 1000;"
                        unit: kWh
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_wiser_lts_energy_salon
                        name: Chauffage du salon (convecteur)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_wiser_lts_energy_salon_2
                        name: Chauffage du salon (inertie)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_wiser_lts_energy_bureau
                        name: Chauffage du bureau
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.monthly_wiser_lts_energy_chambre
                        name: Chauffage de la chambre
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
                      - entity: sensor.prise_chambre_2_summation_delivered_2
                        name: Prise de la chambre (entrée)
                        stroke_width: 1
                        yaxis_id: elec
                        group_by:
                          duration: 1d
                          func: max
              attributes:
                label: Mensuelle

            - card: ### Comparatif (à venir...)
                type: vertical-stack
                cards:
                  - type: picture
                    image: /local/img/Jo_STeF-2GHz-qrcode.png
              attributes:
                label: Comparatif (à venir...)

        - type: custom:apexcharts-card
          header:
            show: true
            title: Temps réel
            show_states: true
            colorize_states: true
          chart_type: donut
          color_list: [var(--primary-color), var(--secondary-color), var(--third-color), var(--fourth-color), var(--fifth-color)]
          show:
            last_updated: true
          apex_config:
            chart:
              height: 550px
              fontFamily: var(--primary-font-family)
            tooltip:
              style:
                fontSize: 14px
            legend:
              show : false
            stroke:
              show: true
              width: 1
            dataLabels:
              formatter: |
                EVAL:function(value) {
                  return value.toFixed(0) + " %";
                }
            plotOptions:
              pie:
                donut:
                  labels:
                    show: true
                    total:
                      show: true
                      label: Total
                      fontSize: '30px'
                      fontFamily: 'Helvetica, Arial, sans-serif'
                      fontWeight: 600
                      color: '#373d3f'
                      formatter: |
                        EVAL:function(w) {
                          return w.globals.seriesTotals.reduce((a, b) => {return (a + b)} , 0).toFixed(0) + " W"
                          }
          all_series_config:
            opacity: 0.1
          series:
            - entity: sensor.plug_bureau_power
              name: PC Bureau
            - entity: sensor.plug_media_salon_power
              name: Media salon
            - entity: sensor.plug_chambre_power
              name: Prises chambre (lit)
            - entity: sensor.wiser_lts_power_salon
              name: Chauffage du salon (convecteur)
            - entity: sensor.wiser_lts_power_salon_2
              name: Chauffage du salon (inertie)
            - entity: sensor.wiser_lts_power_bureau
              name: Chauffage du bureau
            - entity: sensor.wiser_lts_power_chambre
              name: Chauffage de la chambre
            # - entity: sensor.tz3000_2putqrmw_ts011f_active_power
            #   name: Prise du bar
            - entity: sensor.prise_chambre_2_active_power_2
              name: Prise de la chambre (entrée)


